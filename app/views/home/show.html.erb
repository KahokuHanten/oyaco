<script>
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })

  function inputNote(noteTitle, eventId) {
    $("#input_note_title").text(noteTitle+"のメモを追加")
    $("#input_note_id").val(eventId)
  }
</script>

<section class="topics">
  <div class="container-fluid">
  <div class="row">
  <div class="timeline col-sm-8">
    <dl>
      <% m = Month(Date.current) %>
      <%
         display_month = user_signed_in? ? 12 : 6
         m.upto(m + display_month ) do |m|
      %>
        <dt><%= "#{m.year}年#{m.number}月" %></dt>
        <% m_topics = @topics.select {|t| m.include?(t[:date])} %>
        <% m_topics.each_with_index do |topic, i| %>
          <span class="anchor" <%= "id=event#{topic[:id]}" if topic[:id].present? %> ></span>
          <dd class="<%= timeline_pos(i) %> <%= "#{topic[:type]}" %> clearfix">
            <div class="circ"></div>
            <div class="time"><%= "#{topic[:date].day}日" %></div>
            <div class="events">
              <div class="pull-left">
                <% if topic[:image].present? %>
                  <%= image_tag "#{topic[:image]}", class: "events-object img-rounded" %>
                <% else %>
                  <%= image_tag "s64_f_event_13_0bg.png", class: "events-object img-rounded" %>
                <% end %>
              </div>
              <div class="events-body">
                <h4 class="events-heading"><%= topic[:title] %></h4>
                <% if topic[:wikipedia].present? %>
                  <p class="wikipedia"><%= truncate(topic[:wikipedia], length: 100) %>
                    <%= link_to "[Wikipedia]", "http://ja.wikipedia.org/wiki/#{topic[:name]}", target: "_new" %>
                  </p>
                <% end %>
                <p><%= topic[:comment1] %></p>
                <p><%= topic[:comment2] %></p>
                <p><%= topic[:comment3] %></p>
                <% if topic[:message].present? %>
                <p>こんな言葉を贈ってはどうですか？</p>
                <p>「<%= topic[:message] %>」</p>
                <% end %>
                <% if topic[:item] %>
                  <a href="<%= topic[:item][:url] %>" target="_new">
                  <img class="gift img-rounded" src="<%= topic[:item][:imageUrl] %>">
                </a>
                <% end %>
                <% if topic[:id].present? %>
                  <%= link_to raw('<i class="fa fa-comment fa-lg"></i>'), "#input-event-note", data: {toggle: "modal"}, onclick: ("inputNote('"+topic[:name]+"','"+topic[:id].to_s+"')").html_safe, class: "pull-right bottom-aligned-text" %>
                <% end %>
                <% if topic[:type] == :user %>
                  <%= link_to raw('<i class="fa fa-trash fa-lg"></i>'), users_event_path(topic[:event]), method: :delete, data: {confirm: "本当に削除しますか？"}, class: "pull-right bottom-aligned-text" %>
                <% end %>
              </div>
            </div>
          </dd>
        <% end %>
      <% end %>
    </dl>
    <% unless user_signed_in? %>
    <button class="btn btn-primary btn-block regist-recommend h4" data-toggle="collapse"  href="#collapseExample">OYACO始めてみませんか？</button>
    <div class="collapse" id="collapseExample">
      <div class="well">
        <p>OYACOにユーザ登録すると便利な機能がご利用いただけます。</p>
        <p><h5><i class="fa fa-paper-plane"></i>イベントのお知らせ</h5>親孝行イベントの1ヶ月前からご登録メールアドレスにお知らせメールを送付します。</p>
        <p><h5><i class="fa fa-calendar"></i>記念日の登録</h5>あなただけの記念日をOYACOイベントに登録できます。</p>
        <a class="btn btn-primary" href="<%= new_user_registration_path %>"><i class="fa fa-plus"></i>ユーザ登録する</a>
      </div>
    </div>
    <% end %>
  </div>
  <div class="col-sm-4">

  <% if @pref_name.present? %>
    <div class="panel panel-warning">
      <div class="panel-heading">
        <h4 class="panel-title"><%= @pref_name %>情報</h4>
      </div>
      <div class="panel-body">
        <p><%= @pref_name %>は<%= @warning_comment %></p>
        <% if @googlenews["items"] %>
          <% @googlenews["items"].first(3).each do |news| %>
            <%= link_to news["title"], news["link"], target: "_new" %><br>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

    <div class="panel panel-primary">
      <div class="panel-heading">
        <h4 class="panel-title">みんなの親孝行</h4>
      </div>
      <div class="panel-body">
        <div class="pull-left">
          <a href="https://twitter.com/intent/tweet?button_hashtag=%E8%A6%AA%E5%AD%9D%E8%A1%8C" class="twitter-hashtag-button" data-size="large" data-url="http://oyaco.herokuapp.com">Tweet #%E8%A6%AA%E5%AD%9D%E8%A1%8C</a>
        </div>
        <a class="twitter-timeline-container"
          data-widget-id="670199121928523778"
          data-widget-options="<%= {height: 600, chrome: 'noborders noheader nofooter'}.to_json %>"
          href="https://twitter.com/TwitterDev"
        ></a>
      </div>

    </div>

    <div class="panel panel-success">
      <div class="panel-heading">
        <h4 class="panel-title">趣味</h4>
      </div>
      <div class="panel-body">
        <% @hobbys.each do |hobby| %>
          <b><%= hobby[:name] %>のニュース</b>
          <% if hobby[:news]["items"] %>
            <ul>
            <% hobby[:news]["items"].first(3).each do |news| %>
              <li><%= link_to news["title"], news["link"], target: "_new" %></li>
            <% end %>
            </ul>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
</div>
</section>

<div id="input-event" class="modal fade">  <!-- Modal本体 -->
  <div class="modal-dialog"> <!-- Modalダイアログ部分 -->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>  <!-- closeボタン -->
        <h4 class="modal-title">記念日を追加</h4>
      </div>
      <div class="modal-body">
        <%= simple_form_for [:users, @event] do |f| %>
          <%= f.input :date, as: :date_picker %>
          <%= f.input :name %>
          <%= f.button :submit %>
        <% end %>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="input-event-note" class="modal fade">  <!-- Modal本体 -->
  <div class="modal-dialog"> <!-- Modalダイアログ部分 -->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>  <!-- closeボタン -->
        <h4 id="input_note_title" class="modal-title">メモを追加</h4>
      </div>
      <div class="modal-body">
        <%= simple_form_for [:users, @note] do |f| %>
          <input type="hidden" id="input_note_id" name="input_note_id" value="">
          <%= f.input :body %>
          <%= f.button :submit %>
        <% end %>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
